<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>{:lang('兑换密码设定')}</title>
    <script type="text/javascript" src="__STATIC__/js/jquery.min.js"></script>    
    <script type="text/javascript" src="__STATIC__/js/num-alignment.js"></script>
    <link rel="stylesheet" href="__STATIC__/css/bootstrap.min.css" />   
    <link rel="stylesheet" href="__STATIC__/css/common.css" /> 
    <link rel="stylesheet" href="__STATIC__/css/Integral.css" />
     <script src="__STATIC__/layer/mobile/layer.js" rel="stylesheet"></script>
    <script type="text/javascript">
    	
   		document.addEventListener('plusready', function(){
   			//console.log("所有plus api都应该在此事件发生后调用，否则会出现plus is undefined。"
   		});
   		
    </script>
</head>
<body>
	<div id="box">
		<div class="Integral">
			<!--页面背景颜色-->
			
			<!--页面顶部积分兑换详情-->
			<!-- <div class="Integral_return exchange_password1">
				<a href="exchange_password1.html" class="fl">积分兑换</a>
				<a href="#"> </a>
			</div> -->
			<!--注册兑换密码 -->
			<div class="exchange_registered">
				<div class="modal_content">		
					<div>
						<label for="phone1">{:lang('ADMIN_PHONE_NUMBER')}：</label><br />
						<input id="phone1" type="text" autocomplete="off" placeholder="{:lang('请输入已绑定的手机号')}"/>
					</div> 
					<div>
						<label for="code1">{:lang('验证码')}：</label>
						<div class="code1">
							<input id="code1" type="text" autocomplete="off" placeholder="{:lang('短信验证码')}"/>
							<input id="btnSendCode1" type="button" class="btn btn-default" value="{:lang('获取验证码')}" onClick="sendMessage1()" />
						</div>				
					</div> 	
					<div>
						<label for="pass1">{:lang('设置密码')}：</label><br />
						<input id="pass1" type="password" autocomplete="off" placeholder="{:lang('请输入您设置6位数密码')}"/>
					</div>
					<div>
						<label for="pass2">{:lang('重复密码')}：</label><br />
						<input id="pass2" type="password" autocomplete="off" placeholder="{:lang('请再次输入您的密码')}"/>
					</div>
					<div class="next">  			
						<a href="javascript:;" class="exchange_btn" data-uid="{$uid}">{:lang('OK')}</a>
					</div>
				</div>	 	
			</div>
		</div>
	</div>
</body>
<script>
			var phoneReg = /(^1[3|4|5|7|8]\d{9}$)|(^09\d{8}$)/;//手机号正则 
			var count = 60; //间隔函数，1秒执行
			var InterValObj1; //timer变量，控制时间
			var curCount1;//当前剩余秒数
			const lang="{$lang}";
			/*第一*/
			function sendMessage1() {
				curCount1 = count;		 		 
				var phone = $.trim($('#phone1').val());
				if (!phoneReg.test(phone)) {
					layer.open({
			            content: "{:lang('请输入有效的手机号码')}"
			            ,skin: 'msg'
			            ,time: 2 //2秒后自动关闭
			          });
					return false;
				}				
				//发送验证码
		        $.ajax({
		            type: "POST",
		            url: "/api/login_api/code",
		            data: { mobile: phone}
		        }).done(function( msg) {
		        	layer.open({
			            content: msg['msg']
			            ,skin: 'msg'
			            ,time: 2 //2秒后自动关闭
			          });   
		            if(msg['code'] == 1){
		            	//设置button效果，开始计时
						$("#btnSendCode1").attr("disabled", "true");
						$("#btnSendCode1").val("{:lang('秒再获取',['second'=>" + curCount1 + "])}");
						InterValObj1 = window.setInterval(SetRemainTime1, 1000); //启动计时器，1秒执行一次
		            }
		        });	 
			}
			function SetRemainTime1() {
				if (curCount1 == 0) {                
					window.clearInterval(InterValObj1);//停止计时器
					$("#btnSendCode1").removeAttr("disabled");//启用按钮
					$("#btnSendCode1").val("{:lang('重新发送')}");
				}
				else {
					curCount1--;
					$("#btnSendCode1").val("{:lang('秒再获取',['second'=>" + curCount1 + "])}");
				}
			} 
			/*提交*/
			$(".exchange_btn").click(function(){
				var phone = $.trim($('#phone1').val());
				var code1 = $.trim($('#code1').val());
				var pass1 = $.trim($('#pass1').val());
				var pass2 = $.trim($('#pass2').val());
				var uid = $(this).attr("data-uid");
				if(pass1.length < 6){
					layer.open({
			            content: "{:lang('密码不能小于6位数')}"
			            ,skin: 'msg'
			            ,time: 2 //2秒后自动关闭
			          });
					return false;
				}
				if(pass2 != pass1){
					layer.open({
			            content: "{:lang('2次输入的密码不一致')}"
			            ,skin: 'msg'
			            ,time: 2 //2秒后自动关闭
			          });
					return false;
				}
				 $.ajax({
				    type: 'POST',
				    url: "{:url('exchange_api/exchange_upd_password')}?lang="+lang,
				    data: {'phone': phone,'psd':pass1,'code':code1,'uid':uid},
				    dataType: 'json',
				    success: function (data) {
				    	
				 		if(data.code == 1){
				 			layer.open({
				            content: data.msg
				            ,skin: 'msg'
				            ,time: 2 //2秒后自动关闭
				            ,end:function () {
                           		var url="{:url('exchange_api/integral')}?uid="+uid+"&lang="+lang;
								window.location.href=url;
                            }
				          });
				 		}else{
				 			layer.open({
					            content: data.msg
					            ,skin: 'msg'
					            ,time: 2 //2秒后自动关闭
					          });
				 		}
				    }
				  });

			})

			//发送验证码

		</script>
</html>