<html>
<include file="public@header"/>
<style>
    .gift-img {
        width: 50px;
        height: 50px
    }

    .gift-img img {
        width: 100%;
        height: 100%;
    }

    .gift-in input {
        width: 30px;
    }

    .qiniu-box {
        margin-top: 30px;
    }
</style>
<body>
<div class="wrap js-check-wrap">
    <ul class="nav nav-tabs">
        <li><a href="{:url('upload/index')}">{:lang('腾讯云上传记录')}</a></li>
        <li class="active"><a href="javascript:;">{:lang('腾讯云上传工具')}</a></li>
    </ul>

    <div class="qiniu-box">
        <table class="table table-hover table-bordered table-list">
            <thead>
            <tr>
                <th>{:lang('文件地址')}</th>
                <th width="400">{:lang('选择文件')}</th>
            </tr>
            </thead>
            <tfoot>
            <tr>
                <td>
                    <div class="apk-url"></div>
                </td>
                <td>
                    <input type="button" id="uploadBoxArea" class="button green" value="{:lang('上传')}" onclick= "$('#upload1').click();" >
                    <input type="file" id="upload1" name="upload" onchange="uploadFile(this);" style="display: none;">
                    <span class="qiniu_percent"></span>
                </td>

            </tr>
            </tfoot>
        </table>
    </div>

</div>
<script src="__STATIC__/js/layer/layer.js" rel="stylesheet"></script>
<script src="https://unpkg.com/cos-js-sdk-v5/dist/cos-js-sdk-v5.min.js"></script>
<script type="text/javascript">
    //拖拽
    var dz = document.getElementById('uploadBoxArea');
    //var dz =$('.green');
    dz.ondragover = function (ev) {
        //阻止浏览器默认打开文件的操作
        ev.preventDefault();
        //拖入文件后边框颜色变红
        this.style.borderColor = 'red';
    }
    dz.ondragleave = function () {
        //恢复边框颜色
        this.style.borderColor = 'gray';
    }
    dz.ondrop = function (ev) {
        //恢复边框颜色
        this.style.borderColor = 'gray';
        //阻止浏览器默认打开文件的操作
        ev.preventDefault();
        //console.log(ev.dataTransfer.files);return;
        var files = ev.dataTransfer.files;
        if(files.length>0){
            //fastadmin框架调用的真实文件上传方法，对应改成你自己的逻辑
            /*Upload.api.send(files[0], function (data) {
                Controller.uploadSuccess(data);
            });*/
            uploadFile(ev.dataTransfer);
        }
    }

    //var COS = require('cos-js-sdk-v5');
    var cos = new COS({
        UseAccelerate: true, // 指定 true，使用全球加速域名请求
        // 必选参数
        getAuthorization: function (options, callback) {
            // 服务端例子：https://github.com/tencentyun/qcloud-cos-sts-sdk/blob/master/scope.md
            $.ajax({
                url: "{:url('upload/get_qiniu_upload_token')}",
                type: 'post',
                dataType: 'json',
                //data: {id: id},
                success: function (data) {
                    console.log(data)
                    var credentials = data && data.credentials;
                    if (data.code == 1) {
                        callback({
                            TmpSecretId: credentials.tmpSecretId,
                            TmpSecretKey: credentials.tmpSecretKey,
                            SecurityToken: credentials.sessionToken,
                            // 建议返回服务器时间作为签名的开始时间，避免用户浏览器本地时间偏差过大导致签名错误
                            StartTime: data.startTime, // 时间戳，单位秒，如：1580000000
                            ExpiredTime: data.expiredTime, // 时间戳，单位秒，如：1580000900
                            //ScopeLimit: true, // 细粒度控制权限需要设为 true，会限制密钥只在相同请求时重复使用
                        });
                    } else {
                        layer.msg("token获取失败", {time: 2000, icon: 2});
                    }
                }
            });
        }
    });

    function uploadFile(obj){
        var file = obj['files'][0];
        //var fileName = file.name;
        //getToken();
        //console.log(file);return;
        var token = '';
        var time = new Date();
        var x = 1000000;
        var y = 9999999;
        var rand = parseInt(Math.random() * (x - y + 1) + y);
        var fileName = Date.parse(new Date(time))+'_'+rand+'_'+file.name;
        $.ajax({
            url: "{:url('qiniu/get_qiniu_upload_token')}",
            type: 'post',
            dataType: 'json',
            //data: {id: id},
            success: function (data) {

                if (data.code == 1) {
                    var domain = data.domain;
                    var bucket = data.bucket;
                    var qiniuToken = data.token;
                    var observable = qiniu.upload(
                        file, //上传图片的blob对象
                        fileName, //图片名
                        qiniuToken, //token
                        {
                            fname: fileName,
                            params: {}, //用来放置自定义变量
                            mimeType: null
                        }, {
                            useCdnDomain: true,
                            region: qiniu.region.z0
                        }
                    );
                    observable.subscribe({
                        next(nextData){
                            $('.qiniu_percent').html(nextData.total.percent+'%');
                            //console.log(nextData);
                        },
                        error(error){
                            console.log(error);
                        },
                        complete(res) {
                            //图片上传成功之后，获取图片地址，添加到img标签的src内，连同其他标签元素一起追加到图片显示区域
                            var qiniuImgUrl = domain+'/'+res.key;
                            $('.apk-url').html(qiniuImgUrl);
                            //console.log(qiniuImgUrl);
                            add_log(qiniuImgUrl);
                        }
                    });
                } else {
                    layer.msg("token获取失败", {time: 2000, icon: 2});
                }
            }
        });
        $('.upload1').value = "";
        //this.filebox("setValue","");
        //this.filebox("disableValidation");
    };

    $(".del").click(function () {
        var id = $(this).attr('data-id');
        layer.confirm("{:lang('DELETE_CONFIRM_MESSAGE')}", {
            btn: ["{:lang('OK')}", "{:lang('OFF')}"] //按钮
        }, function () {
            $.ajax({
                url: "{:url('gift/del')}",
                type: 'post',
                dataType: 'json',
                data: {id: id},
                success: function (data) {
                    if (data == '1') {
                        layer.msg("{:lang('DELETE_SUCCESS')}", {time: 2000, icon: 1}, function () {
                            window.location.reload();
                        });
                    } else {
                        layer.msg("{:lang('DELETE_FAILED')}", {time: 2000, icon: 2});
                    }
                }
            });

        });
    })
    $(".btn-primary").click(function () {
        $(".js-ajax-form").submit();
    })

    function add_log($url){
        $.ajax({
            url: "{:url('qiniu/add_log')}",
            type: 'post',
            dataType: 'json',
            data: {url: $url},
            success: function (data) {
                if (data == '1') {
                    layer.msg("{:lang('操作成功')}", {time: 2000, icon: 1});
                } else {
                    layer.msg("{:lang('操作失败')}", {time: 2000, icon: 2});
                }
            }
        });
    }
</script>
</body>
</html>
