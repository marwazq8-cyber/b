<html>
<include file="public@header"/>
<style>
    .gift-img {
        width: 50px;
        height: 50px
    }

    .gift-img img {
        width: 100%;
        height: 100%;
    }

    .gift-in input {
        width: 30px;
    }

    .qiniu-box {
        margin-top: 30px;
    }
</style>
<body>
<div class="wrap js-check-wrap">
    <ul class="nav nav-tabs">
        <li><a href="{:url('qiniu/index')}">{:lang('ADMIN_UPLOAD_LOG')}</a></li>
<!--        <li><a href="{:url('qiniu/add')}">{:lang('ADMIN_UPLOAD_QIINIU')}</a></li>-->
        <li class="active"><a href="javascript:;">{:lang('ADMIN_UPLOAD_CLOUD')}</a></li>
    </ul>

    <div class="qiniu-box">
        <table class="table table-hover table-bordered table-list">
            <thead>
            <tr>
                <th>{:lang('ADMIN_DOCUMENT')}</th>
                <th width="400">{:lang('ADMIN_DOCUMENT_CHOOSE')}</th>
            </tr>
            </thead>
            <tfoot>
            <tr>
                <td>
                    <div class="apk-url"></div>
                </td>
                <td>
                    <input type="button" id="uploadBoxArea" class="button green" value="{:lang('上传')}" onclick= "$('#upload1').click();" >
                    <input type="file" id="upload1" name="upload" onchange="uploadFile(this);" style="display: none;">
                    <span class="qiniu_percent"></span>
                </td>

            </tr>
            </tfoot>
        </table>
    </div>

</div>
<script src="__STATIC__/js/layer/layer.js" rel="stylesheet"></script>
<script src="__STATIC__/js/cos-js-sdk-v5.min.js"></script>

<script src="https://unpkg.com/qiniu-js@3.1.2/dist/qiniu.min.js" rel="stylesheet"></script>
<script type="text/javascript">
    //拖拽
    var dz = document.getElementById('uploadBoxArea');
    //var dz =$('.green');
    dz.ondragover = function (ev) {
        //阻止浏览器默认打开文件的操作
        ev.preventDefault();
        //拖入文件后边框颜色变红
        this.style.borderColor = 'red';
    }
    dz.ondragleave = function () {
        //恢复边框颜色
        this.style.borderColor = 'gray';
    }
    dz.ondrop = function (ev) {
        //恢复边框颜色
        this.style.borderColor = 'gray';
        //阻止浏览器默认打开文件的操作
        ev.preventDefault();
        //console.log(ev.dataTransfer.files);return;
        var files = ev.dataTransfer.files;
        if(files.length>0){
            //fastadmin框架调用的真实文件上传方法，对应改成你自己的逻辑
            /*Upload.api.send(files[0], function (data) {
                Controller.uploadSuccess(data);
            });*/
            up_token();
            //uploadFile(ev.dataTransfer);
        }
    }

    function up_token(){
        // 初始化实例
        var cos = new COS({
            UseAccelerate: true, // 指定 true，使用全球加速域名请求
            getAuthorization: function (options, callback) {
                // 异步获取临时密钥
                $.get("{:url('qiniu/get_qcloud_update_token')}", {
                    bucket: options.Bucket,
                    region: options.Region,
                }, function (data) {
                    console.log(data);return;
                    var credentials = data && data.credentials;
                    if (!data || !credentials) return console.error('credentials invalid');
                    callback({
                        TmpSecretId: credentials.tmpSecretId,
                        TmpSecretKey: credentials.tmpSecretKey,
                        SecurityToken: credentials.sessionToken,
                        // 建议返回服务器时间作为签名的开始时间，避免用户浏览器本地时间偏差过大导致签名错误
                        StartTime: data.startTime, // 时间戳，单位秒，如：1580000000
                        ExpiredTime: data.expiredTime, // 时间戳，单位秒，如：1580000900
                    });
                });
            }
        });
    }


    function uploadFile(obj){
        var Bucket = "{$data['bucket']}";
        var Region = "{$data['region']}";     /* 存储桶所在地域，必须字段 */
        var url = "{$data['bucket_url']}";
        var http_val = "{$data['accelerate_domain_name']}";
        var cos = new COS({
            UseAccelerate: true, // 指定 true，使用全球加速域名请求
            getAuthorization: function (options, callback) {
                $.ajax({
                    method: 'POST',
                    url: "{:url('qiniu/get_qcloud_update_token')}",
                    data: JSON.stringify(options.Scope),
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader('Content-Type', 'application/json');
                    },
                    dataType: 'json',
                    success: function (data) {
                        console.log(data)
                        var credentials = data && data.credentials;
                        if (!data || !credentials) return console.error('credentials invalid');
                        callback({
                            TmpSecretId: credentials.tmpSecretId,
                            TmpSecretKey: credentials.tmpSecretKey,
                            SecurityToken: credentials.sessionToken,
                            // 建议返回服务器时间作为签名的开始时间，避免用户浏览器本地时间偏差过大导致签名错误
                            StartTime: data.startTime, // 时间戳，单位秒，如：1580000000
                            ExpiredTime: data.expiredTime, // 时间戳，单位秒，如：1580000900
                            ScopeLimit: false, // 细粒度控制权限需要设为 true，会限制密钥只在相同请求时重复使用
                        });
                    }
                });
            }
        });
        var file = obj['files'][0];
        //var fileName = file.name;
        //getToken();
        //console.log(file);return;
        var token = '';
        var time = new Date();
        var x = 1000000;
        var y = 9999999;
        var rand = parseInt(Math.random() * (x - y + 1) + y);
        var fileName = Date.parse(new Date(time))+'_'+rand+'_'+file.name;
        //uploadFile
        cos.uploadFile({
            Bucket: Bucket, /* 必须 */
            Region: Region,     /* 存储桶所在地域，必须字段 */
            Key: fileName,              /* 必须 */
            Body: file,                /* 必须 */
            SliceSize: 1024 * 1024 * 5,     /* 触发分块上传的阈值，超过5MB使用分块上传，非必须 */
            onTaskReady: function(taskId) {                   /* 非必须 */
                console.log(taskId);
            },
            onProgress: function (progressData) {           /* 非必须 */
                console.log(JSON.stringify(progressData));

                var percent = progressData.percent * 100;
                $('.qiniu_percent').html(percent+'%');
            },
            onFileFinish: function (err, data, options) {
                console.log(options.Key + "{:lang('上传')}" + (err ? "{:lang('失败')}" : "{:lang('完成')}"));
            },
        }, function(err, data) {
            console.log(err || data);
            if(data){
                let qiniuImgUrl;
                if (http_val){
                    qiniuImgUrl = http_val+'/'+fileName;
                }else{
                    qiniuImgUrl = url + '/' + fileName;
                }

                $('.apk-url').html(qiniuImgUrl);
                //console.log(qiniuImgUrl);
                add_log(qiniuImgUrl);
            }

        });
    };

    $(".del").click(function () {
        var id = $(this).attr('data-id');
        layer.confirm("{:lang('DELETE_CONFIRM_MESSAGE')}", {
            btn: ["{:lang('确定')}", "{:lang('取消')}"] //按钮
        }, function () {
            $.ajax({
                url: "{:url('gift/del')}",
                type: 'post',
                dataType: 'json',
                data: {id: id},
                success: function (data) {
                    if (data == '1') {
                        layer.msg("{:lang('DELETE_SUCCESS')}", {time: 2000, icon: 1}, function () {
                            window.location.reload();
                        });
                    } else {
                        layer.msg("{:lang('DELETE_FAILED')}", {time: 2000, icon: 2});
                    }
                }
            });

        });
    })
    $(".btn-primary").click(function () {
        $(".js-ajax-form").submit();
    })

    function add_log($url){
        $.ajax({
            url: "{:url('qiniu/add_log')}",
            type: 'post',
            dataType: 'json',
            data: {url: $url},
            success: function (data) {
                if (data == '1') {
                    layer.msg("{:lang('上传成功')}", {time: 2000, icon: 1});
                } else {
                    layer.msg("{:lang('上传失败')}", {time: 2000, icon: 2});
                }
            }
        });
    }
</script>
</body>
</html>
