<html>
<include file="public@header"/>
<style>
    .gift-img {
        width: 50px;
        height: 50px
    }

    .gift-img img {
        width: 100%;
        height: 100%;
    }

    .gift-in input {
        width: 30px;
    }

    .qiniu-box {
        margin-top: 30px;
    }
</style>
<body>
<div class="wrap js-check-wrap">
    <ul class="nav nav-tabs">
        <li class="active"><a href="javascript:;">{:lang('ADMIN_UPLOAD_LOG')}</a></li>
<!--        <li><a href="{:url('qiniu/add')}">{:lang('ADMIN_UPLOAD_QIINIU')}</a></li>-->
        <li><a href="{:url('qiniu/cloud')}">{:lang('ADMIN_UPLOAD_CLOUD')}</a></li>
    </ul>

    <div class="qiniu-box">
        <table class="table table-hover table-bordered table-list">
            <thead>
            <tr>
                <th>ID</th>
                <th>url</th>
                <th>{:lang('ADD_TIME')}</th>
                <!--                <th>{:lang('ACTIONS')}</th>-->
            </tr>
            </thead>
            <tfoot>
            <foreach name="list" id="vo">
                <tr>
                    <td>{$vo.id}</td>
                    <td>{$vo.url}</td>

                    <td>{$vo.create_time | date="Y-m-d H:i:s",###}</td>
                    <!--                    <td>
                                            <a href="{:url('gift/add',array('id'=>$vo.id))}">{:lang('编辑')}</a> |
                                            <a href="javescript:;" class="del" data-id="{$vo.id}">{:lang('DELETE')}</a>
                                        </td>-->
                </tr>
            </foreach>
            </tfoot>
        </table>
    </div>

</div>
<script src="__STATIC__/js/layer/layer.js" rel="stylesheet"></script>
<script src="https://unpkg.com/qiniu-js@3.1.2/dist/qiniu.min.js" rel="stylesheet"></script>
<script type="text/javascript">
    function uploadFile(obj){
        var file = obj['files'][0];
        //var fileName = file.name;
        //getToken();
        //console.log(file);return;
        var token = '';
        var time = new Date();
        var x = 1000000;
        var y = 9999999;
        var rand = parseInt(Math.random() * (x - y + 1) + y);
        var fileName = Date.parse(new Date(time))+'_'+rand+'_'+file.name;
        $.ajax({
            url: "{:url('qiniu/get_qiniu_upload_token')}",
            type: 'post',
            dataType: 'json',
            //data: {id: id},
            success: function (data) {

                if (data.code == 1) {
                    var domain = data.domain;
                    var bucket = data.bucket;
                    var qiniuToken = data.token;
                    var observable = qiniu.upload(
                        file, //上传图片的blob对象
                        fileName, //图片名
                        qiniuToken, //token
                        {
                            fname: fileName,
                            params: {}, //用来放置自定义变量
                            mimeType: null
                        }, {
                            useCdnDomain: true,
                            region: qiniu.region.z0
                        }
                    );
                    observable.subscribe({
                        next(nextData){
                            $('.qiniu_percent').html(nextData.total.percent+'%');
                            //console.log(nextData);
                        },
                        error(error){
                            console.log(error);
                        },
                        complete(res) {
                            //图片上传成功之后，获取图片地址，添加到img标签的src内，连同其他标签元素一起追加到图片显示区域
                            var qiniuImgUrl = domain+'/'+res.key;
                            $('.apk-url').html(qiniuImgUrl);
                            //console.log(qiniuImgUrl);
                            add_log(qiniuImgUrl);
                        }
                    });
                } else {
                    layer.msg("token获取失败", {time: 2000, icon: 2});
                }
            }
        });
        $('.upload1').value = "";
        //this.filebox("setValue","");
        //this.filebox("disableValidation");
    };

    $(".del").click(function () {
        var id = $(this).attr('data-id');
        layer.confirm("{:lang('DELETE_CONFIRM_MESSAGE')}", {
            btn: ["{:lang('确定')}", "{:lang('取消')}"] //按钮
        }, function () {
            $.ajax({
                url: "{:url('gift/del')}",
                type: 'post',
                dataType: 'json',
                data: {id: id},
                success: function (data) {
                    if (data == '1') {
                        layer.msg("{:lang('DELETE_SUCCESS')}", {time: 2000, icon: 1}, function () {
                            window.location.reload();
                        });
                    } else {
                        layer.msg("{:lang('DELETE_FAILED')}", {time: 2000, icon: 2});
                    }
                }
            });

        });
    })
    $(".btn-primary").click(function () {
        $(".js-ajax-form").submit();
    })

    function add_log($url){
        $.ajax({
            url: "{:url('qiniu/add_log')}",
            type: 'post',
            dataType: 'json',
            data: {url: $url},
            success: function (data) {
                if (data == '1') {
                    layer.msg("{:lang('上传成功')}", {time: 2000, icon: 2});
                } else {
                    layer.msg("{:lang('上传失败')}", {time: 2000, icon: 2});
                }
            }
        });
    }
</script>
</body>
</html>
